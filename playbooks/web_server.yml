---

- hosts:        web-server
  become:       yes
  become_user:  root
  gather_facts: false
  pre_tasks:
    - name:         Install python 2.7 for Ansible
      raw:          test -e /usr/bin/python || (apt -y update && apt -y install python-minimal)
      changed_when: false

    - name:         Install aptitude for Ansible
      raw:          test -e aptitude || (apt -y update && apt -y install aptitude)
      changed_when: false

    - name:  Setup and gather facts
      setup:
  roles:
    - server
    - webuser
    - nginx
    - php
    - composer
    - postgresql

    - php_censor
    - role:                        php_censor
      php_censor_db_name:          "{{ php_censor_db_name_test }}"
      php_censor_db_user:          "{{ php_censor_db_user_test }}"
      php_censor_db_password:      "{{ php_censor_db_password_test }}"
      php_censor_db_dump_filename: "{{ php_censor_db_dump_filename_test }}"
      php_censor_queue_name:       "{{ php_censor_queue_name_test }}"
      php_censor_hostname:         "{{ php_censor_hostname_test }}"
      php_censor_url:              "{{ php_censor_url_test }}"

    - corpsee_site
    - role:                          corpsee_site
      corpsee_site_db_name:          "{{ corpsee_site_db_name_test }}"
      corpsee_site_db_user:          "{{ corpsee_site_db_user_test }}"
      corpsee_site_db_password:      "{{ corpsee_site_db_password_test }}"
      corpsee_site_db_dump_filename: "{{ corpsee_site_db_dump_filename_test }}"
      corpsee_site_hostname:         "{{ corpsee_site_hostname_test }}"
